name: chromatic

# on:
#   pull_request:
#   push:
#     branches:
#       - master

on: push

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Use Node.js
        uses: actions/setup-node@v2
        with:
          node-version: "16"

      - name: Install dependencies
        run: npm install

      - name: Execute tests
        run: npm run test --runInBand

      - name: Check that the `package.json` version is different from the last tagged version on the commit.
        run: |
          chmod +x .ci/versions-match.bash
          VERSIONS_MATCH=`.ci/versions-match.bash`
          if [ $VERSIONS_MATCH == "true" ]; then exit 135; fi
        if: github.ref == 'refs/heads/master'

      - name: Tag new version
        run: |
          export NEW_VERSION=$(sed 's/.*"version": "\(.*\)".*/\1/;t;d' ./package.json)
          git tag ${NEW_VERSION}
          git push --tags
        if: github.ref == 'refs/heads/master' && contains(github.event.head_commit.modified, 'package.json')

      - name: Publish new version to the react-components GCloud repository
        run: |
          .ci/refresh_auth_token.bash
          npm run build
          npm publish
        if: github.ref == 'refs/heads/master' && contains(github.event.head_commit.modified, 'package.json')

      - name: Publish stories on Chromatic
        run: |
          # --exit-zero-on-changes is necessary in order to not failing if test snapshots render without errors but with changes.
          # More info here https://www.chromatic.com/docs/bitbucket-pipelines#command-exit-code-for-required-checks
          # This may change in the future and this flag could be non necessary.
          npm run chromatic --exit-zero-on-changes
        if: github.ref == 'refs/heads/master' && contains(github.event.head_commit.modified, 'package.json')
